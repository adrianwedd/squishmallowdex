# Squishmallowdex Solution Design

**Version:** 1.1.0
**Date:** 2026-01-04
**Author:** Claude (Code Review)
**Status:** Draft - Revision 5 (Ready for Implementation)

## Revision History

| Rev | Date | Changes |
|-----|------|---------|
| 1 | 2026-01-04 | Initial draft |
| 2 | 2026-01-04 | Addressed review feedback: expanded XSS fix to all text fields, added try/finally for all exit paths, changed progress sync to batch-level, deferred streaming HTML, added CSS considerations for --thumb-size, clarified --dry-run side effects, added Phase 4.5 for documentation |
| 3 | 2026-01-04 | Delete stale help.txt, add requirements-test.txt for test deps, fix success criteria, define --dry-run flag precedence, note fsync limitations, add None guards to cleanup |
| 4 | 2026-01-04 | Fix inconsistencies: align revision history with requirements-test.txt decision, update version roadmap, remove setup.sh from scope |
| 5 | 2026-01-04 | Add work distribution: Codex (1,2,4.5) â†’ Claude (3,4,5), sequential commits |

---

## 1. Executive Summary

This document outlines proposed improvements to Squishmallowdex based on a comprehensive code review. Changes are organized into phases, prioritized by impact and risk. The goal is to improve reliability, performance, security, and maintainability while preserving the educational, beginner-friendly nature of the codebase.

**Scope:** `squishmallowdex.py`, `test_squishmallowdex.py`, documentation (`README.md`, `USAGE.md`)

**Out of Scope:** HTML/CSS redesign, new data sources, database backend

---

## 2. Current State Analysis

### 2.1 Strengths
- Well-documented, educational code with extensive comments
- Good CLI design with grouped arguments
- Robust progress/resume system
- Fun, engaging output for young users
- Self-contained HTML output works offline
- Comprehensive test suite foundation

### 2.2 Areas for Improvement

| Category | Issues Found | Risk Level |
|----------|--------------|------------|
| Security | 2 (XSS, input validation) | High |
| Bugs | 4 (deprecation, race conditions) | Medium |
| Performance | 4 (memory, redundant I/O) | Medium |
| Code Quality | 8 (globals, long functions) | Low |
| Testing | 5 (missing coverage) | Low |

---

## 3. Proposed Changes

### Phase 1: Critical Fixes (Security & Bugs)

#### 1.1 HTML Escaping for All Text Fields
**Problem:** ALL text content from wiki is inserted into HTML without escaping, creating XSS risk. This affects Name, Type, Color, Squad, Size(s), Collector Number, Year, and Bio columns.

**Location:** `squishmallowdex.py:1018-1032`

**Current Code:**
```python
val = row.get(col) or ""
cells.append(f'<td data-col="{i}">{val}</td>')
```

**Proposed Solution:**
```python
from html import escape  # Already imported at line 34

# Define which columns contain our generated HTML (safe)
HTML_COLUMNS = {"Image", "Page", "â™¥", "Own"}

# In render_html, when building cells:
val = row.get(col) or ""
if col not in HTML_COLUMNS:
    val = escape(str(val))  # Escape ALL text columns
cells.append(f'<td data-col="{i}">{val}</td>')
```

**Affected Columns:**
| Column | Source | Risk |
|--------|--------|------|
| Name | Wiki H1/og:title | Medium - could contain quotes/scripts |
| Type | Wiki infobox | Low - but still untrusted |
| Color | Wiki infobox | Low |
| Squad | Wiki infobox | Low |
| Size(s) | Wiki infobox | Low |
| Collector Number | Wiki infobox | Low |
| Year | Wiki infobox | Low |
| Bio | Wiki section text | High - free-form text |
| Image | Our generated `<a><img>` | Safe (we control) |
| Page | Our generated `<a>` | Safe (we control) |

**Testing:** Add tests with malicious content in multiple fields:
```python
def test_xss_prevention_in_name():
    rows = [{"Name": "<script>alert('xss')</script>", ...}]
    # Verify output contains &lt;script&gt;

def test_xss_prevention_in_bio():
    rows = [{"Bio": '<img onerror="alert(1)" src=x>', ...}]
    # Verify onerror is escaped
```

---

#### 1.2 Fix Pillow LANCZOS Deprecation
**Problem:** `Image.LANCZOS` deprecated in Pillow 10+, will break on newer versions.

**Location:** `squishmallowdex.py:978`

**Current Code:**
```python
img.thumbnail((max_size, max_size), Image.LANCZOS)
```

**Proposed Solution:**
```python
# At module level, after PIL import:
if HAS_PIL:
    PIL_RESAMPLING = getattr(Image, 'Resampling', Image).LANCZOS

# In function:
img.thumbnail((max_size, max_size), PIL_RESAMPLING)
```

**Testing:** Verify works on Pillow 9.x and 10.x.

---

#### 1.3 Session and Log Resource Management
**Problem:** `requests.Session` opened but never closed, leaking connections. Additionally, `log.close_log()` is not called on all exit paths:
- `--stats-only` path returns at line 1941 without closing session
- Exceptions can skip `log.close_log()` at line 2076

**Location:** `squishmallowdex.py:1901-1941, 2056-2076`

**Current Issue Paths:**
```python
# --stats-only path (line 1924-1941):
if args.stats_only:
    ...
    log.close_log()
    return  # Session never closed!

# Main path - exceptions skip cleanup:
# ... main loop ...
log.close_log()  # Skipped if exception raised
```

**Proposed Solution:** Wrap entire main flow in try/finally with None guards:
```python
def main() -> None:
    global log

    # ... argument parsing ...

    # Initialize to None so finally can check
    session = None

    # Log setup (before try so we can log errors)
    log.open_log()

    try:
        session = requests.Session()

        # ALL code paths go here:
        # - --stats-only
        # - --rebuild
        # - normal collection
        # - --dry-run (new)

        if args.stats_only:
            _handle_stats_only(args, session, rows)
            return

        # ... rest of main logic ...

    finally:
        # Guard against partial initialization
        if session is not None:
            session.close()
        log.close_log()  # AdventureLog.close_log() is safe if not opened
```

**Safety Note:** `AdventureLog.close_log()` must be safe to call even if `open_log()` wasn't called or failed. Current implementation already handles this (checks `_file_handle` is not None).

**Alternative:** Use nested context managers:
```python
def main() -> None:
    # ... setup ...

    with requests.Session() as session:
        log.open_log()
        try:
            # ... all logic ...
        finally:
            log.close_log()
```

**Testing:**
- Verify no resource warnings with `python -W all`
- Test early exit paths (--stats-only, --help, Ctrl+C)
- Test exception paths (network failure mid-run)

---

#### 1.4 Progress File Write Strategy
**Problem:** Current approach opens/closes file for each URL. Adding `fsync()` per write would cause severe performance degradation (potentially 100x slower on some systems).

**Location:** `squishmallowdex.py:1692-1695`

**Current Code:**
```python
def append_progress(progress_path: str, url: str) -> None:
    with open(progress_path, "a", encoding="utf-8") as f:
        f.write(url + "\n")
```

**Analysis of Options:**

| Approach | Durability | Performance | Complexity |
|----------|------------|-------------|------------|
| Current (no sync) | Low | Fast | Simple |
| fsync per write | High | Very slow | Simple |
| fsync per batch | Medium-High | Good | Medium |
| Open once, line-buffered | Medium | Fast | Medium |

**Proposed Solution:** Batch-level fsync (sync once per batch, not per URL):

```python
# In main(), after batch save:
if collected_in_batch >= args.batch_size:
    log.step(f"Batch {batch_number} complete! Saving your progress...")
    save_collection(...)

    # Sync progress file once per batch (not per URL)
    _sync_progress_file(args.progress_file)

def _sync_progress_file(progress_path: str) -> None:
    """Ensure progress file is durably written to disk."""
    if os.path.exists(progress_path):
        with open(progress_path, "a") as f:
            f.flush()
            os.fsync(f.fileno())
```

**Alternative:** Keep file handle open for session with line buffering:
```python
class ProgressWriter:
    def __init__(self, path: str):
        self._f = open(path, "a", encoding="utf-8", buffering=1)  # Line buffered

    def append(self, url: str) -> None:
        self._f.write(url + "\n")  # Flushed automatically per line

    def sync(self) -> None:
        self._f.flush()
        os.fsync(self._f.fileno())

    def close(self) -> None:
        self.sync()
        self._f.close()
```

**Decision:** Use batch-level fsync. Simpler than ProgressWriter class, good durability/performance tradeoff. Users lose at most one batch on crash (10 URLs by default).

**Known Limitation:** `fsync()` on the file does not sync directory metadata. On first file creation, the directory entry itself is not guaranteed durable until the parent directory is also fsynced. This is an accepted limitation because:
1. Progress file is recreated from CSV on next run if missing
2. Full directory fsync adds complexity (`os.open(dir, O_DIRECTORY)` + `os.fsync()`)
3. The CSV is the authoritative source; progress file is optimization only

If stronger durability is needed in future, add:
```python
def _sync_directory(path: str) -> None:
    """Sync directory metadata (for new file durability)."""
    dir_fd = os.open(os.path.dirname(path), os.O_RDONLY | os.O_DIRECTORY)
    try:
        os.fsync(dir_fd)
    finally:
        os.close(dir_fd)
```

---

#### 1.5 Improve Error Logging in Image Processing
**Problem:** Silent exception swallowing makes debugging impossible.

**Location:** `squishmallowdex.py:984-985`

**Current Code:**
```python
except Exception:
    return None
```

**Proposed Solution:**
```python
except Exception as e:
    # Only log in verbose mode to avoid noise
    if log.verbose >= 2:
        log.debug(f"Image processing failed for {image_source}: {e}")
    return None
```

---

### Phase 2: Performance Improvements

#### 2.1 Pre-compile ANSI Regex
**Problem:** Regex compiled on every call to `_strip_ansi`.

**Location:** `squishmallowdex.py:334-336`

**Proposed Solution:**
```python
@dataclass
class AdventureLog:
    # Add as class variable (not instance):
    _ANSI_PATTERN: ClassVar[re.Pattern] = re.compile(r'\033\[[0-9;]*m')

    def _strip_ansi(self, text: str) -> str:
        return self._ANSI_PATTERN.sub('', text)
```

**Impact:** Minor CPU savings, but good practice.

---

#### 2.2 Cache-Aware Image Embedding
**Problem:** `--embed-images` downloads from URL even when local cache exists.

**Location:** `squishmallowdex.py:1612-1620`

**Current Flow:**
1. Check if `download_images` is True
2. If so, download to local cache
3. For embedding, try local file first, then URL

**Issue:** If `--no-download-images` is set but cache exists from previous run, we still fetch from URL.

**Proposed Solution:**
```python
def build_html_rows(...):
    for idx, row in enumerate(rows, 1):
        img_url = row.get("ImageURL") or ""
        local_img = None

        # Always check cache first (even if not downloading new)
        if img_url:
            cached_path = _get_cached_image_path(images_dir, img_url)
            if os.path.exists(cached_path):
                local_img = cached_path
            elif download_images:
                local_img = download_image(session, img_url, images_dir, refresh)

        if embed_images:
            # Prefer local, fallback to URL fetch
            img_src = image_to_base64_thumbnail(local_img, session) if local_img else None
            if not img_src and img_url:
                img_src = image_to_base64_thumbnail(img_url, session)
            img_src = img_src or img_url
        else:
            img_src = local_img or img_url
```

**New Helper:**
```python
def _get_cached_image_path(images_dir: str, url: str) -> str:
    """Get the expected cache path for an image URL."""
    ext = os.path.splitext(urlparse(url).path)[1].lower()
    if ext not in (".jpg", ".jpeg", ".png", ".webp", ".gif"):
        ext = ".jpg"
    return os.path.join(images_dir, f"{_sha1(url)}{ext}")
```

**Impact:** Significant speedup for `--stats-only --embed-images` when cache exists.

---

#### 2.3 HTML Generation Optimization
**Problem:** Building 3000+ rows as strings creates a large intermediate string before writing.

**Location:** `squishmallowdex.py:1018-1033, 1589-1590`

**Analysis:**
The `rows` list is already fully in memory (loaded from CSV or collected). Streaming HTML output only eliminates the intermediate `body_rows` list and final joined string - not the source data.

| Data Structure | Size (3000 rows) | Can Eliminate? |
|----------------|------------------|----------------|
| `rows` list | ~3-5 MB | No (needed for CSV) |
| `body_rows` list | ~2-3 MB | Yes |
| Final HTML string | ~5-8 MB | Yes |

**Revised Assessment:**
- Memory savings: ~5-10 MB (not 50% as originally claimed)
- For a script that downloads images, this is negligible
- Complexity cost outweighs benefit

**Decision:** **DEFER** - Remove from Phase 2.

If memory becomes a real issue in future, the proper solution would be:
1. Stream rows from CSV instead of loading all into memory
2. Use generator pattern throughout pipeline
3. This is a larger refactor not justified by current use case

**Alternative Quick Win:** Use `io.StringIO` instead of list+join (same memory, slightly faster):
```python
from io import StringIO
buffer = StringIO()
for row in rows:
    buffer.write(_render_row(row))
html = buffer.getvalue()
```

**Status:** Moved to "Future Considerations" section.

---

### Phase 3: Code Quality

#### 3.1 Extract Constants
**Problem:** Magic numbers scattered throughout code.

**Proposed Constants:**
```python
# === Configuration Constants ===
MAX_BIO_LENGTH = 2500  # Maximum characters to extract from Bio section
MIN_IMAGE_SIZE = 100   # Minimum bytes for valid image
DEFAULT_THUMBNAIL_SIZE = 100  # Pixels for embedded thumbnails
DEFAULT_THUMBNAIL_QUALITY = 60  # JPEG quality for thumbnails
REQUEST_TIMEOUT = 30   # Seconds for HTTP requests
IMAGE_TIMEOUT = 15     # Seconds for image downloads
```

---

#### 3.2 Import Organization
**Problem:** Imports not following PEP 8 grouping.

**Proposed Order:**
```python
#!/usr/bin/env python3
"""Module docstring..."""

from __future__ import annotations

# === Standard Library ===
import argparse
import base64
import csv
import hashlib
import json
import os
import random
import re
import sys
import time
from collections import Counter
from dataclasses import dataclass, field
from html import escape
from io import BytesIO
from typing import TYPE_CHECKING, ClassVar, TextIO
from urllib.parse import quote, urljoin, urlparse

# === Third Party ===
import requests
from bs4 import BeautifulSoup

# === Optional Dependencies ===
try:
    from PIL import Image
    HAS_PIL = True
except ImportError:
    HAS_PIL = False
```

---

#### 3.3 Reduce Global State
**Problem:** Global `log` variable makes testing difficult.

**Current:**
```python
log: AdventureLog = AdventureLog()  # Global

def some_function():
    log.info("message")  # Uses global
```

**Proposed Approach (Minimal Change):**
Keep global for simplicity (this is educational code), but document it:
```python
# Global logger instance - initialized in main()
# This is intentionally global for simplicity in this educational codebase.
# For production code, consider dependency injection.
log: AdventureLog
```

**Full Refactor (Optional):**
Pass `log` as parameter to all functions. This is cleaner but adds complexity for learners.

**Decision:** Document the global, don't refactor. Keep code beginner-friendly.

---

#### 3.4 Extract `render_html` Components
**Problem:** Single 600-line function is hard to maintain.

**Proposed Structure:**
```python
def render_html(rows: list[dict], out_path: str, title: str, logo_path: str = "") -> None:
    """Render collection to self-contained HTML file."""
    config = _build_column_config()
    css = _generate_css()
    js = _generate_javascript(config)
    header = _render_header(title, logo_path, css)
    table = _render_table(rows, config)

    html = f"""<!doctype html>
<html lang="en">
{header}
<body>
{_render_page_header(title, logo_path)}
{table}
<script>{js}</script>
</body>
</html>"""

    with open(out_path, "w", encoding="utf-8") as f:
        f.write(html)


def _build_column_config() -> list[dict]:
    """Define column configuration for the table."""
    ...

def _generate_css() -> str:
    """Generate inline CSS styles."""
    ...

def _generate_javascript(config: list[dict]) -> str:
    """Generate inline JavaScript for interactivity."""
    ...
```

**Impact:** Easier to modify individual components.

**Risk:** Low - pure refactoring, no behavior change.

---

### Phase 4: New Features

#### 4.1 Add `--dry-run` Flag
**Purpose:** Preview what would be collected without making any persistent changes.

**Side Effect Policy:**

| Action | Normal Mode | --dry-run |
|--------|-------------|-----------|
| Fetch master list | Yes (cached) | Yes (cached) |
| Cache master list | Yes | Yes |
| Fetch squish pages | Yes (cached) | **No** |
| Cache squish pages | Yes | **No** |
| Download images | Yes | **No** |
| Write progress file | Yes | **No** |
| Write CSV | Yes | **No** |
| Write HTML | Yes | **No** |
| Console output | Yes | Yes (with "[DRY RUN]" prefix) |

**Rationale:**
- Master list cache is allowed (harmless, speeds up subsequent runs)
- All other writes are skipped
- User sees what WOULD be collected

**Implementation:**

```python
collect.add_argument(
    "--dry-run",
    action="store_true",
    help="Preview collection without downloading or saving anything.",
)

# Early in main(), after fetching master list:
if args.dry_run:
    log.step("[DRY RUN] Previewing what would be collected...")

# In main loop:
for u in urls:
    if u in processed_urls or u in skipped_urls:
        continue
    if limit is not None and dry_run_count >= limit:
        break

    if args.dry_run:
        # Only show what we WOULD do, don't actually do it
        page_name = u.split("/")[-1].replace("_", " ")
        log.info(f"[DRY RUN] Would fetch: {page_name}")
        dry_run_count += 1
        continue  # Skip all actual work

    # Normal processing...
    page_html = fetch(...)
```

**Output Example:**
```
[DRY RUN] Previewing what would be collected...
  â„¹ï¸  [DRY RUN] Would fetch: Fifi the Fox
  â„¹ï¸  [DRY RUN] Would fetch: Gordon the Shark
  â„¹ï¸  [DRY RUN] Would fetch: Wendy the Frog
  ...
  â„¹ï¸  [DRY RUN] Would collect 50 new Squishmallows
  â„¹ï¸  [DRY RUN] No files were modified
```

**Flag Precedence:**

When `--dry-run` is combined with other flags:

| Combination | Behavior |
|-------------|----------|
| `--dry-run --stats-only` | Error: mutually exclusive (stats-only reads existing, dry-run previews new) |
| `--dry-run --embed-images` | Ignored: no HTML generated in dry-run |
| `--dry-run --json` | Ignored: no JSON generated in dry-run |
| `--dry-run --thumb-size N` | Ignored: no embedding in dry-run |
| `--dry-run --limit N` | Respected: limits preview count |
| `--dry-run --refresh` | Allowed: would show what would be re-fetched |

**Implementation of Mutual Exclusion:**
```python
if args.dry_run and args.stats_only:
    ap.error("--dry-run and --stats-only are mutually exclusive")
```

**Testing:**
- Verify no files created/modified after dry run
- Verify progress file unchanged
- Verify cache only contains master list
- Verify error on `--dry-run --stats-only`

---

#### 4.2 Add `--thumb-size` Option
**Purpose:** Allow customizing embedded thumbnail size for file size vs quality tradeoff.

**Design Decision:** Thumbnail size affects BOTH:
1. **Actual image dimensions** (embedded base64 data)
2. **Display size** (CSS must adapt)

**Implementation:**

```python
# CLI argument
collect.add_argument(
    "--thumb-size",
    type=int,
    default=100,
    metavar="PX",
    help="Thumbnail size in pixels for --embed-images (default: 100).",
)

# Pass to image_to_base64_thumbnail:
image_to_base64_thumbnail(img_url, session, max_size=args.thumb_size)

# Update CSS generation to use dynamic sizing:
def _generate_css(thumb_size: int = 100) -> str:
    # Calculate display size (can be different from actual)
    display_size = min(thumb_size, 72)  # Cap display at 72px for UI consistency

    return f"""
    img.thumb {{
        width: {display_size}px;
        height: {display_size}px;
        max-width: {thumb_size}px;
        max-height: {thumb_size}px;
        object-fit: cover;
        ...
    }}
    """
```

**Current CSS (hardcoded):** `squishmallowdex.py:1238-1244`
```css
img.thumb {
    width: 72px;
    height: 72px;
    ...
}
```

**Behavior Matrix:**

| --thumb-size | Actual Size | Display Size | File Impact |
|--------------|-------------|--------------|-------------|
| 50 | 50px | 50px | ~1KB/image |
| 100 (default) | 100px | 72px | ~2.5KB/image |
| 150 | 150px | 72px | ~5KB/image |
| 200 | 200px | 72px | ~8KB/image |

**Rationale:** Display capped at 72px for UI consistency. Larger `--thumb-size` gives higher quality when user clicks to zoom, without breaking table layout.

**Alternative:** Let display size = actual size (simpler, but UI may break with large values)

---

#### 4.3 Add `--json` Export Format
**Purpose:** Machine-readable export for integration with other tools.

**Implementation:**
```python
output.add_argument(
    "--json",
    metavar="FILE",
    help="Export collection as JSON file.",
)

# In save_collection:
if json_path:
    with open(json_path, "w", encoding="utf-8") as f:
        json.dump(rows, f, indent=2, ensure_ascii=False)
```

---

### Phase 4.5: Documentation Updates

**Requirement:** All new flags must be documented to prevent drift between code and docs.

#### Files Requiring Updates

| File | Section | Updates Needed |
|------|---------|----------------|
| `README.md` | Commands | Add `--dry-run`, `--json`, `--thumb-size` examples |
| `USAGE.md` | All sections | Full documentation of new flags |
| `--help` output | Built-in | Automatically updated via argparse |
| `help.txt` | **DELETE** | Stale artifact, out of sync with current --help |

#### Delete Stale Artifact
```bash
git rm help.txt
```
**Rationale:** `help.txt` is a static copy of `--help` output that has drifted from the actual implementation. Rather than maintain two sources of truth, delete it. Users should run `--help` for current options.

#### README.md Changes
```markdown
## Commands

```bash
# Preview what would be collected (no changes made)
python3 squishmallowdex.py --dry-run --limit 50

# Export as JSON for use in other tools
python3 squishmallowdex.py --stats-only --json collection.json

# Create smaller embedded thumbnails (faster, smaller file)
python3 squishmallowdex.py --stats-only --embed-images --thumb-size 50
```
```

#### USAGE.md Changes
Add new section:
```markdown
## Advanced Options

### Preview Mode (--dry-run)
See what would be collected without making any changes:
```bash
python3 squishmallowdex.py --dry-run --limit 100
```

### Export Formats
Export your collection in different formats:
```bash
# JSON export (for programmers)
python3 squishmallowdex.py --stats-only --json my_collection.json

# CSV export (default, for spreadsheets)
python3 squishmallowdex.py --stats-only --csv my_collection.csv
```

### Thumbnail Size (--thumb-size)
Control embedded image quality vs file size:
```bash
# Smaller thumbnails = smaller HTML file
python3 squishmallowdex.py --embed-images --thumb-size 50

# Larger thumbnails = better quality when zooming
python3 squishmallowdex.py --embed-images --thumb-size 150
```
```

**Verification:** After implementation, run `--help` and compare against README/USAGE to ensure consistency.

---

### Phase 5: Testing Improvements

#### 5.0 Test Dependencies

**Problem:** Phase 5 introduces `responses` or `pytest-httpserver` for network mocking, but these are not installed by `setup.sh`.

**Solution:** Add optional test dependencies:

**Option A: Separate test requirements file** (recommended)
```bash
# requirements-test.txt
pytest>=7.0
responses>=0.23
```

```bash
# Run tests with:
pip3 install -r requirements-test.txt
python3 -m pytest test_squishmallowdex.py -v
```

**Option B: Add to setup.sh with optional flag**
```bash
# In setup.sh, add optional test setup:
if [ "$1" = "--dev" ]; then
    echo "ðŸ“¦ Installing test dependencies..."
    pip3 install --quiet pytest responses
fi
```

**Decision:** Use Option A (requirements-test.txt). Keeps production install lightweight, makes test deps explicit.

**Documentation:** Add to USAGE.md:
```markdown
## Running Tests

Install test dependencies:
```bash
pip3 install -r requirements-test.txt
```

Run tests:
```bash
python3 -m pytest test_squishmallowdex.py -v
```
```

---

#### 5.1 Add Missing Test Coverage

**New Tests Needed:**

| Function | Test Cases |
|----------|------------|
| `parse_infobox` | Valid infobox, empty infobox, missing labels |
| `image_to_base64_thumbnail` | Local file, URL, corrupt image, missing file |
| `build_html_rows` | With/without embedding, with/without images |
| `render_html` | XSS prevention, special characters in names |
| `main` | Integration test with mocked network |

**Example Test:**
```python
class TestImageToBase64Thumbnail:
    def test_local_file(self):
        # Create temp image, verify base64 output
        ...

    def test_returns_none_for_missing_file(self):
        result = sq.image_to_base64_thumbnail("/nonexistent.jpg")
        assert result is None

    def test_handles_corrupt_image(self):
        # Write garbage bytes to file, verify graceful failure
        ...
```

---

#### 5.2 Add Network Mocking
**Tool:** `responses` or `pytest-httpserver`

```python
import responses

class TestFetch:
    @responses.activate
    def test_fetch_caches_response(self):
        responses.add(
            responses.GET,
            "https://example.com/page",
            body="<html>test</html>",
        )
        # First call hits network
        # Second call should use cache
```

---

## 4. Implementation Plan

### Work Distribution

**Parallel development with sequential commits to avoid merge conflicts.**

| Agent | Phases | Focus |
|-------|--------|-------|
| **Codex** | 1, 2, 4.5 | Critical fixes, performance, docs cleanup |
| **Claude** | 3, 4, 5 | Refactoring, new features, tests |

**Execution Order:**
```
1. Codex: Phase 1 (critical fixes)
2. Codex: Phase 2 (performance)
3. Codex: Phase 4.5 (docs cleanup)
4. Codex: commit + push
5. Claude: rebase on Codex's work
6. Claude: Phase 3 (code quality)
7. Claude: Phase 4 (new features)
8. Claude: Phase 5 (testing)
9. Claude: commit + push
```

**Rationale:** Both agents touch `main()`, `render_html`, and `build_html_rows`. Sequential commits ensure Codex's structural changes (try/finally, escaping) are in place before Claude adds features on top.

**Coordination Points:**
- Codex leaves `render_html` as single function; Claude extracts helpers
- Codex adds escaping in cell loop; Claude preserves when extracting
- Codex wraps main() in try/finally; Claude adds args inside that structure

---

### Phase 1: Critical Fixes
**Estimated Effort:** 2 hours
**Risk:** Low
**Dependencies:** None

| Task | Files | Lines Changed |
|------|-------|---------------|
| 1.1 HTML Escaping (all text fields) | squishmallowdex.py | ~10 |
| 1.2 LANCZOS Fix | squishmallowdex.py | ~5 |
| 1.3 Session/Log Cleanup (try/finally) | squishmallowdex.py | ~20 |
| 1.4 Batch-level Progress Sync | squishmallowdex.py | ~15 |
| 1.5 Error Logging | squishmallowdex.py | ~5 |

### Phase 2: Performance
**Estimated Effort:** 1.5 hours
**Risk:** Low
**Dependencies:** Phase 1

| Task | Files | Lines Changed |
|------|-------|---------------|
| 2.1 Regex Precompile | squishmallowdex.py | ~5 |
| 2.2 Cache-Aware Embedding | squishmallowdex.py | ~30 |
| ~~2.3 Streaming HTML~~ | ~~DEFERRED~~ | - |

### Phase 3: Code Quality
**Estimated Effort:** 2 hours
**Risk:** Low
**Dependencies:** None (can parallelize with Phase 2)

| Task | Files | Lines Changed |
|------|-------|---------------|
| 3.1 Constants | squishmallowdex.py | ~20 |
| 3.2 Import Cleanup | squishmallowdex.py | ~10 |
| 3.3 Document Global | squishmallowdex.py | ~5 |
| 3.4 Extract Functions | squishmallowdex.py | ~100 (refactor) |

### Phase 4: Features
**Estimated Effort:** 2.5 hours
**Risk:** Low
**Dependencies:** Phase 1

| Task | Files | Lines Changed |
|------|-------|---------------|
| 4.1 --dry-run | squishmallowdex.py | ~25 |
| 4.2 --thumb-size (with CSS) | squishmallowdex.py | ~20 |
| 4.3 --json export | squishmallowdex.py | ~20 |

### Phase 4.5: Documentation
**Estimated Effort:** 0.5 hours
**Risk:** None
**Dependencies:** Phase 4

| Task | Files | Lines Changed |
|------|-------|---------------|
| 4.5.1 README updates | README.md | ~20 |
| 4.5.2 USAGE updates | USAGE.md | ~50 |
| 4.5.3 Delete stale help.txt | help.txt | DELETE |

### Phase 5: Testing
**Estimated Effort:** 3 hours
**Risk:** Low
**Dependencies:** All phases

| Task | Files | Lines Changed |
|------|-------|---------------|
| 5.0 Test dependencies | requirements-test.txt | NEW (~3 lines) |
| 5.1 New Tests (XSS, embedding, etc.) | test_squishmallowdex.py | ~150 |
| 5.2 Network Mocking | test_squishmallowdex.py | ~50 |

---

## 5. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Breaking existing collections | Low | High | Test with real CSV files |
| Performance regression | Low | Medium | Benchmark before/after |
| Pillow compatibility | Medium | Medium | Test on multiple versions |
| User confusion from new flags | Low | Low | Update documentation |

---

## 6. Success Criteria

- [ ] All existing tests pass
- [ ] New tests for all Phase 1 changes
- [ ] No security warnings from `bandit` scan
- [ ] HTML output identical for existing collections (excluding escaping fixes)
- [ ] `--embed-images` with cached images is 2x faster
- [ ] ~~Memory usage reduced for 3000+ row collections~~ *(Removed: streaming HTML deferred)*
- [ ] `--dry-run` produces no side effects (except master list cache)
- [ ] `--dry-run --stats-only` produces clear error message

---

## 7. Rollback Plan

Each phase produces a separate commit. If issues arise:
1. `git revert <commit>` for specific phase
2. Re-release previous version
3. Document issue for future fix

---

## 8. Approval

| Role | Name | Status |
|------|------|--------|
| Author | Claude | Draft |
| Reviewer | Adrian | Pending |

---

## Appendix A: File Changes Summary

```
squishmallowdex.py
â”œâ”€â”€ Imports (reorder per PEP 8)
â”œâ”€â”€ Constants (new section: MAX_BIO_LENGTH, THUMBNAIL_SIZE, etc.)
â”œâ”€â”€ PIL_RESAMPLING (Pillow 10+ compatibility)
â”œâ”€â”€ AdventureLog._ANSI_PATTERN (precompiled regex)
â”œâ”€â”€ _get_cached_image_path() (new helper)
â”œâ”€â”€ _sync_progress_file() (new helper)
â”œâ”€â”€ image_to_base64_thumbnail (error logging)
â”œâ”€â”€ render_html
â”‚   â”œâ”€â”€ HTML_COLUMNS constant
â”‚   â”œâ”€â”€ escape() all text fields
â”‚   â”œâ”€â”€ Dynamic CSS for thumb_size
â”‚   â””â”€â”€ (Optional) Extract to helper functions
â”œâ”€â”€ build_html_rows (cache-aware embedding)
â”œâ”€â”€ main
â”‚   â”œâ”€â”€ try/finally for session/log cleanup
â”‚   â”œâ”€â”€ --dry-run flag and logic
â”‚   â”œâ”€â”€ --thumb-size flag
â”‚   â”œâ”€â”€ --json flag
â”‚   â””â”€â”€ Batch-level progress sync
â””â”€â”€ ~200 lines changed total

test_squishmallowdex.py
â”œâ”€â”€ TestXSSPrevention (new)
â”‚   â”œâ”€â”€ test_xss_in_name
â”‚   â”œâ”€â”€ test_xss_in_bio
â”‚   â””â”€â”€ test_xss_in_type
â”œâ”€â”€ TestImageToBase64Thumbnail (new)
â”‚   â”œâ”€â”€ test_local_file
â”‚   â”œâ”€â”€ test_url_fetch
â”‚   â””â”€â”€ test_corrupt_image
â”œâ”€â”€ TestDryRun (new)
â”œâ”€â”€ TestResourceCleanup (new)
â””â”€â”€ TestNetworkMocking (new)
â””â”€â”€ ~200 lines added

README.md
â”œâ”€â”€ Commands section (new examples)
â””â”€â”€ ~20 lines added

USAGE.md
â”œâ”€â”€ Advanced Options section (new)
â”œâ”€â”€ --dry-run documentation
â”œâ”€â”€ --json documentation
â”œâ”€â”€ --thumb-size documentation
â”œâ”€â”€ Running Tests section (new)
â””â”€â”€ ~50 lines added

requirements-test.txt (NEW)
â”œâ”€â”€ pytest>=7.0
â”œâ”€â”€ responses>=0.23
â””â”€â”€ 3 lines

help.txt
â””â”€â”€ DELETED (stale artifact)
```

---

## Appendix B: Version Roadmap

| Version | Contents |
|---------|----------|
| 1.0.0 | Current release |
| 1.1.0 | **This design:** Phases 1-5 (all phases) |

**Rationale:** All phases are interconnected (Phase 5 tests Phase 1 fixes, Phase 4.5 documents Phase 4 features). Shipping as a single release ensures consistency. Total effort ~11.5 hours is reasonable for one version bump.

**Alternative (if incremental releases preferred):**

| Version | Contents |
|---------|----------|
| 1.0.1 | Phase 1 only (critical fixes) |
| 1.1.0 | Phases 2-5 (features + quality + tests) |

---

*End of Document*
